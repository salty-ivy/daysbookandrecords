<!-- book_detail.html -->
{% extends "base.html" %}
{% load wagtailcore_tags %}

{% block title %}{{ book.title }} by {{ book.author }} - Days Books & Records{% endblock %}

{% block content %}
<div class="book-detail-container">
    <div class="container">
        <div class="book-detail-content">
            <!-- Book Cover Section -->
            <div class="book-cover-section">
                {% if book.image %}
                    <img src="{{ book.image.url }}" alt="{{ book.title }}" class="book-detail-cover">
                {% else %}
                    <div class="book-detail-cover-placeholder">
                        <span class="placeholder-text">{{ book.title|truncatechars:30 }}</span>
                    </div>
                {% endif %}
            </div>

            <!-- Book Information Section -->
            <div class="book-info-section">
                <div class="book-header">
                    <h1 class="book-detail-title">{{ book.title }}</h1>
                    <p class="book-detail-author">{{ book.author }}</p>
                    <p class="book-detail-price">£{{ book.price }}</p>
                </div>

                <div class="book-meta">
                    <div class="meta-item">
                        <span class="meta-label">Condition:</span>
                        <span class="book-condition condition-{{ book.condition }}">{{ book.get_condition_display }}</span>
                    </div>
                    {% if book.genre %}
                        <div class="meta-item">
                            <span class="meta-label">Genre:</span>
                            <span class="meta-value">{{ book.genre }}</span>
                        </div>
                    {% endif %}
                    {% if book.publisher %}
                        <div class="meta-item">
                            <span class="meta-label">Publisher:</span>
                            <span class="meta-value">{{ book.publisher }}</span>
                        </div>
                    {% endif %}
                    {% if book.isbn %}
                        <div class="meta-item">
                            <span class="meta-label">ISBN:</span>
                            <span class="meta-value">{{ book.isbn }}</span>
                        </div>
                    {% endif %}
                </div>

                {% if book.description %}
                    <div class="book-description">
                        <h3>Description</h3>
                        <div class="description-content">
                            {{ book.description|richtext }}
                        </div>
                    </div>
                {% endif %}

                                       <div class="book-actions">
                           <button class="btn btn-primary btn-large add-to-cart-btn" onclick="addBookToCart()" style="display: none;">Add to Cart</button>
                           <button class="btn btn-outline btn-large" onclick="addBookToWishlist()">Add to Wishlist</button>
                       </div>

                {% if book.sub_genre.all %}
                    <div class="book-tags">
                        <h4>Tags</h4>
                        <div class="tags-list">
                            {% for tag in book.sub_genre.all %}
                                <span class="tag">{{ tag.name }}</span>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Related Books Section -->
        {% if related_books %}
            <div class="related-books-section">
                <h3>Books you might also like</h3>
                <div class="related-books-grid">
                    {% for related_book in related_books %}
                        <div class="related-book-item">
                            <a href="{{ related_book.get_absolute_url }}" class="related-book-link">
                                <div class="related-book-cover">
                                    {% if related_book.image %}
                                        <img src="{{ related_book.image.url }}" alt="{{ related_book.title }}" class="related-cover-image">
                                    {% else %}
                                        <div class="related-cover-placeholder">
                                            <span class="placeholder-text">{{ related_book.title|truncatechars:20 }}</span>
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="related-book-info">
                                    <h4 class="related-book-title">{{ related_book.title|truncatechars:25 }}</h4>
                                    <p class="related-book-author">{{ related_book.author|truncatechars:20 }}</p>
                                    <p class="related-book-price">£{{ related_book.price }}</p>
                                </div>
                            </a>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
   </div>
</div>

<script>
    function addBookToCart() {
        const bookData = {
            id: '{{ book.id }}',
            type: 'book',
            title: '{{ book.title }}',
            author: '{{ book.author }}',
            price: {{ book.price }},
            image: '{{ book.image.url }}' || null,
            condition: '{{ book.get_condition_display }}'
        };
        
        addToCart(bookData);
    }
    
    function addBookToWishlist() {
        const bookData = {
            id: '{{ book.id }}',
            type: 'book',
            title: '{{ book.title|escapejs }}',
            author: '{{ book.author|escapejs }}',
            price: {{ book.price }},
            image: {% if book.image %}'{{ book.image.url }}'{% else %}null{% endif %},
            condition: '{{ book.get_condition_display|escapejs }}',
            url: '{{ book.get_absolute_url }}'
        };
        
        // Get existing wishlist from localStorage
        let wishlist = JSON.parse(localStorage.getItem('wishlist')) || [];
        
        // Check if item already exists
        const existingItem = wishlist.find(item => 
            item.id === bookData.id && item.type === bookData.type
        );
        
        if (existingItem) {
            alert('This item is already in your wishlist!');
            return;
        }
        
        // Add to wishlist
        wishlist.push({
            ...bookData,
            addedAt: new Date().toISOString()
        });
        
        localStorage.setItem('wishlist', JSON.stringify(wishlist));
        
        // Show success message
        showWishlistMessage('Item added to wishlist!');
    }
    
    function showWishlistMessage(message) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'cart-message';
        messageDiv.textContent = message;
        document.body.appendChild(messageDiv);
        
        setTimeout(() => {
            messageDiv.remove();
        }, 3000);
    }
</script>
{% endblock %}
